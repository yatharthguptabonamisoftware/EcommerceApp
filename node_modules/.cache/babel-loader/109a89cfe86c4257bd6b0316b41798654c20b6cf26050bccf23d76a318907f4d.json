{"ast":null,"code":"import { ref, watch } from 'vue';\nimport { NOOP } from '@vue/shared';\nimport { cloneDeep } from 'lodash-unified';\nfunction getFile(rawFile, uploadFiles) {\n  return uploadFiles.find(file => file.uid === rawFile.uid);\n}\nfunction genUid(seed) {\n  return Date.now() + seed;\n}\nvar useHandlers = props => {\n  const uploadFiles = ref([]);\n  const uploadRef = ref(null);\n  let tempIndex = 1;\n  function abort(file) {\n    uploadRef.value.abort(file);\n  }\n  function clearFiles(status = [\"ready\", \"uploading\", \"success\", \"fail\"]) {\n    uploadFiles.value = uploadFiles.value.filter(row => {\n      return !status.includes(row.status);\n    });\n  }\n  function handleError(err, rawFile) {\n    const file = getFile(rawFile, uploadFiles.value);\n    file.status = \"fail\";\n    uploadFiles.value.splice(uploadFiles.value.indexOf(file), 1);\n    props.onError(err, file, uploadFiles.value);\n    props.onChange(file, uploadFiles.value);\n  }\n  function handleProgress(ev, rawFile) {\n    const file = getFile(rawFile, uploadFiles.value);\n    props.onProgress(ev, file, uploadFiles.value);\n    file.status = \"uploading\";\n    file.percentage = ev.percent || 0;\n  }\n  function handleSuccess(res, rawFile) {\n    const file = getFile(rawFile, uploadFiles.value);\n    if (file) {\n      file.status = \"success\";\n      file.response = res;\n      props.onSuccess(res, file, uploadFiles.value);\n      props.onChange(file, uploadFiles.value);\n    }\n  }\n  function handleStart(rawFile) {\n    const uid = genUid(tempIndex++);\n    rawFile.uid = uid;\n    const file = {\n      name: rawFile.name,\n      percentage: 0,\n      status: \"ready\",\n      size: rawFile.size,\n      raw: rawFile,\n      uid\n    };\n    if (props.listType === \"picture-card\" || props.listType === \"picture\") {\n      try {\n        file.url = URL.createObjectURL(rawFile);\n      } catch (err) {\n        console.error(\"[Element Error][Upload]\", err);\n        props.onError(err, file, uploadFiles.value);\n      }\n    }\n    uploadFiles.value.push(file);\n    props.onChange(file, uploadFiles.value);\n  }\n  function handleRemove(file, raw) {\n    if (raw) {\n      file = getFile(raw, uploadFiles.value);\n    }\n    const revokeObjectURL = () => {\n      if (file.url && file.url.indexOf(\"blob:\") === 0) {\n        URL.revokeObjectURL(file.url);\n      }\n    };\n    const doRemove = () => {\n      abort(file);\n      const fileList = uploadFiles.value;\n      fileList.splice(fileList.indexOf(file), 1);\n      props.onRemove(file, fileList);\n      revokeObjectURL();\n    };\n    if (!props.beforeRemove) {\n      doRemove();\n    } else if (typeof props.beforeRemove === \"function\") {\n      const before = props.beforeRemove(file, uploadFiles.value);\n      if (before instanceof Promise) {\n        before.then(() => {\n          doRemove();\n        }).catch(NOOP);\n      } else if (before !== false) {\n        doRemove();\n      }\n    }\n  }\n  function submit() {\n    uploadFiles.value.filter(file => file.status === \"ready\").forEach(file => {\n      uploadRef.value.upload(file.raw);\n    });\n  }\n  watch(() => props.listType, val => {\n    if (val === \"picture-card\" || val === \"picture\") {\n      uploadFiles.value = uploadFiles.value.map(file => {\n        if (!file.url && file.raw) {\n          try {\n            file.url = URL.createObjectURL(file.raw);\n          } catch (err) {\n            props.onError(err, file, uploadFiles.value);\n          }\n        }\n        return file;\n      });\n    }\n  });\n  watch(() => props.fileList, fileList => {\n    uploadFiles.value = fileList.map(file => {\n      const cloneFile = cloneDeep(file);\n      return {\n        ...cloneFile,\n        uid: file.uid || genUid(tempIndex++),\n        status: file.status || \"success\"\n      };\n    });\n  }, {\n    immediate: true,\n    deep: true\n  });\n  return {\n    abort,\n    clearFiles,\n    handleError,\n    handleProgress,\n    handleStart,\n    handleSuccess,\n    handleRemove,\n    submit,\n    uploadFiles,\n    uploadRef\n  };\n};\nexport { useHandlers as default };","map":{"version":3,"names":["getFile","rawFile","uploadFiles","find","file","uid","genUid","seed","Date","now","useHandlers","props","ref","uploadRef","tempIndex","abort","value","clearFiles","status","filter","row","includes","handleError","err","splice","indexOf","onError","onChange","handleProgress","ev","onProgress","percentage","percent","handleSuccess","res","response","onSuccess","handleStart","name","size","raw","listType","url","URL","createObjectURL","console","error","push","handleRemove","revokeObjectURL","doRemove","fileList","onRemove","beforeRemove","before","Promise","then","catch","NOOP","submit","forEach","upload","watch","val","map","cloneFile","cloneDeep","immediate","deep"],"sources":["/home/bonami/Desktop/Projects/ECommerce/packages/components/upload/src/useHandlers.ts"],"sourcesContent":["import { ref, watch } from 'vue'\nimport { NOOP } from '@vue/shared'\nimport { cloneDeep } from 'lodash-unified'\n\n// Inline types\nimport type {\n  ListType,\n  UploadFile,\n  UploadStatus,\n  ElFile,\n  TwUploadProgressEvent,\n  IUseHandlersProps,\n} from './upload.type'\ntype UploadRef = {\n  abort: (file: UploadFile) => void\n  upload: (file: ElFile) => void\n}\n// helpers\nfunction getFile(rawFile: ElFile, uploadFiles: UploadFile[]) {\n  return uploadFiles.find((file) => file.uid === rawFile.uid)\n}\n\nfunction genUid(seed: number) {\n  return Date.now() + seed\n}\n\nexport default (props: IUseHandlersProps) => {\n  const uploadFiles = ref<UploadFile[]>([])\n  const uploadRef = ref<UploadRef>(null)\n\n  let tempIndex = 1\n\n  function abort(file: UploadFile) {\n    uploadRef.value.abort(file)\n  }\n\n  function clearFiles(\n    status: UploadStatus[] = ['ready', 'uploading', 'success', 'fail']\n  ) {\n    uploadFiles.value = uploadFiles.value.filter((row) => {\n      return !status.includes(row.status)\n    })\n  }\n\n  function handleError(err: Error, rawFile: ElFile) {\n    const file = getFile(rawFile, uploadFiles.value)\n    file.status = 'fail'\n    uploadFiles.value.splice(uploadFiles.value.indexOf(file), 1)\n    props.onError(err, file, uploadFiles.value)\n    props.onChange(file, uploadFiles.value)\n  }\n\n  function handleProgress(ev: TwUploadProgressEvent, rawFile: ElFile) {\n    const file = getFile(rawFile, uploadFiles.value)\n    props.onProgress(ev, file, uploadFiles.value)\n    file.status = 'uploading'\n    file.percentage = ev.percent || 0\n  }\n\n  function handleSuccess(res: any, rawFile: ElFile) {\n    const file = getFile(rawFile, uploadFiles.value)\n    if (file) {\n      file.status = 'success'\n      file.response = res\n      props.onSuccess(res, file, uploadFiles.value)\n      props.onChange(file, uploadFiles.value)\n    }\n  }\n\n  function handleStart(rawFile: ElFile) {\n    const uid = genUid(tempIndex++)\n    rawFile.uid = uid\n    const file: UploadFile = {\n      name: rawFile.name,\n      percentage: 0,\n      status: 'ready',\n      size: rawFile.size,\n      raw: rawFile,\n      uid,\n    }\n    if (props.listType === 'picture-card' || props.listType === 'picture') {\n      try {\n        file.url = URL.createObjectURL(rawFile)\n      } catch (err) {\n        console.error('[Element Error][Upload]', err)\n        props.onError(err, file, uploadFiles.value)\n      }\n    }\n    uploadFiles.value.push(file)\n    props.onChange(file, uploadFiles.value)\n  }\n\n  function handleRemove(file: UploadFile, raw: ElFile) {\n    if (raw) {\n      file = getFile(raw, uploadFiles.value)\n    }\n    const revokeObjectURL = () => {\n      if (file.url && file.url.indexOf('blob:') === 0) {\n        URL.revokeObjectURL(file.url)\n      }\n    }\n    const doRemove = () => {\n      abort(file)\n      const fileList = uploadFiles.value\n      fileList.splice(fileList.indexOf(file), 1)\n      props.onRemove(file, fileList)\n      revokeObjectURL()\n    }\n    if (!props.beforeRemove) {\n      doRemove()\n    } else if (typeof props.beforeRemove === 'function') {\n      const before = props.beforeRemove(file, uploadFiles.value)\n      if (before instanceof Promise) {\n        before\n          .then(() => {\n            doRemove()\n          })\n          .catch(NOOP)\n      } else if (before !== false) {\n        doRemove()\n      }\n    }\n  }\n\n  function submit() {\n    uploadFiles.value\n      .filter((file) => file.status === 'ready')\n      .forEach((file) => {\n        uploadRef.value.upload(file.raw)\n      })\n  }\n\n  watch(\n    () => props.listType,\n    (val: ListType) => {\n      if (val === 'picture-card' || val === 'picture') {\n        uploadFiles.value = uploadFiles.value.map((file) => {\n          if (!file.url && file.raw) {\n            try {\n              file.url = URL.createObjectURL(file.raw)\n            } catch (err) {\n              props.onError(err, file, uploadFiles.value)\n            }\n          }\n          return file\n        })\n      }\n    }\n  )\n\n  watch(\n    () => props.fileList,\n    (fileList: UploadFile[]) => {\n      uploadFiles.value = fileList.map((file) => {\n        const cloneFile = cloneDeep(file)\n        return {\n          ...cloneFile,\n          uid: file.uid || genUid(tempIndex++),\n          status: file.status || 'success',\n        }\n      })\n    },\n    {\n      immediate: true,\n      deep: true,\n    }\n  )\n\n  return {\n    abort,\n    clearFiles,\n    handleError,\n    handleProgress,\n    handleStart,\n    handleSuccess,\n    handleRemove,\n    submit,\n    uploadFiles,\n    uploadRef,\n  }\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}